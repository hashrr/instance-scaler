schemaVersion: '0.3'
description: Scale instances vertically to desired size 
assumeRole: '{{ AutomationAssumeRole }}'
parameters:
  InstanceId:
    type: String
    description: (Required) The ID of the EC2 instance to resize
  Operation:
    type: String
    description: Scale up your instance to m7g.2xlarge or scale down to t4g.small
    allowedValues:
      - scaleUp
      - scaleDown
  AutomationAssumeRole:
    type: String
    description: (Optional) The ARN of the IAM role that allows Systems Manager Automation to perform actions on your behalf
    default: ''
mainSteps:
  - description: Stop the EC2 instance
    name: StopInstance
    action: aws:executeAwsApi
    nextStep: WaitForInstanceToStop
    isEnd: false
    inputs:
      Service: ec2
      Api: StopInstances
      InstanceIds:
        - '{{ InstanceId }}'
    outputs:
      - Name: StoppingInstances
        Selector: $.StoppingInstances
        Type: MapList
  - description: Wait for the instance to reach stopped state
    name: WaitForInstanceToStop
    action: aws:waitForAwsResourceProperty
    timeoutSeconds: 600
    nextStep: ScaleOperation
    isEnd: false
    inputs:
      Service: ec2
      Api: DescribeInstances
      InstanceIds:
        - '{{ InstanceId }}'
      PropertySelector: $.Reservations[0].Instances[0].State.Name
      DesiredValues:
        - stopped
  - name: ScaleOperation
    action: aws:branch
    inputs:
      Choices:
        - NextStep: ScaleUpInstance
          Variable: '{{ Operation }}'
          StringEquals: scaleUp
        - NextStep: ScaleDownInstance
          Variable: '{{ Operation }}'
          StringEquals: scaleDown
      Default: ScaleDownInstance
  - description: Scaling down the instance to t4g.small
    name: ScaleDownInstance
    action: aws:executeAwsApi
    nextStep: StartInstance
    isEnd: false
    inputs:
      Service: ec2
      Api: ModifyInstanceAttribute
      InstanceId: '{{ InstanceId }}'
      InstanceType:
        Value: t4g.small
  - description: Modify the instance type to m7g.2xlarge
    name: ScaleUpInstance
    action: aws:executeAwsApi
    nextStep: StartInstance
    isEnd: false
    inputs:
      Service: ec2
      Api: ModifyInstanceAttribute
      InstanceId: '{{ InstanceId }}'
      InstanceType:
        Value: m7g.2xlarge
  - description: Start the EC2 instance
    name: StartInstance
    action: aws:executeAwsApi
    nextStep: WaitForInstanceToStart
    isEnd: false
    inputs:
      Service: ec2
      Api: StartInstances
      InstanceIds:
        - '{{ InstanceId }}'
    outputs:
      - Name: StartingInstances
        Selector: $.StartingInstances
        Type: MapList
  - description: Wait for the instance to reach running state
    name: WaitForInstanceToStart
    action: aws:waitForAwsResourceProperty
    timeoutSeconds: 600
    isEnd: true
    inputs:
      Service: ec2
      Api: DescribeInstances
      InstanceIds:
        - '{{ InstanceId }}'
      PropertySelector: $.Reservations[0].Instances[0].State.Name
      DesiredValues:
        - running
outputs:
  - StopInstance.StoppingInstances
  - StartInstance.StartingInstances
